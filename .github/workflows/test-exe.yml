name: Test Windows EXE

on:
  workflow_dispatch:  # 手动触发
  workflow_run:
    workflows: ["Build Windows EXE"]
    types:
      - completed

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download and test EXE
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        Write-Host "========================================"
        Write-Host "Windows EXE 自动测试"
        Write-Host "========================================"
        Write-Host ""

        # 获取最新的 Build Windows EXE 构建ID
        Write-Host "1. 获取最新 Build Windows EXE 构建ID..."
        $runId = gh run list --repo $env:GITHUB_REPOSITORY --branch main --workflow=build.yml --json databaseId --limit 1 --jq '.[0].databaseId'
        Write-Host "   构建ID: $runId"
        Write-Host ""

        # 下载artifact
        Write-Host "2. 下载EXE artifact..."
        gh run download "$runId" --name "MinesweeperAI-Windows"
        Write-Host "   下载完成"
        Write-Host ""

        # 列出下载的文件
        Write-Host "3. 检查下载的文件..."
        Get-ChildItem -Recurse | ForEach-Object { Write-Host "   - $($_.FullName)" }
        Write-Host ""

        # 查找EXE（可能在根目录或子目录中）
        Write-Host "4. 查找EXE文件..."
        $exeFile = Get-ChildItem -Recurse -Filter "MinesweeperAI.exe" | Select-Object -First 1

        if ($exeFile) {
          Write-Host "   ✓ 找到EXE: $($exeFile.FullName)"
          # 移动到当前目录
          if ($exeFile.FullName -ne (Join-Path (Get-Location) "MinesweeperAI.exe")) {
            Move-Item -Path $exeFile.FullName -Destination "MinesweeperAI.exe" -Force
            Write-Host "   ✓ 已移动到当前目录"
          }
        } else {
          Write-Error "   ✗ 未找到EXE文件"
          exit 1
        }
        Write-Host ""

        # 验证EXE
        Write-Host "5. 验证EXE文件..."
        if (Test-Path "MinesweeperAI.exe") {
          $size = [math]::Round((Get-Item MinesweeperAI.exe).Length / 1MB, 2)
          Write-Host "   ✓ EXE文件存在"
          Write-Host "   ✓ 文件大小: $size MB"
          Write-Host "   ✓ 创建时间: $((Get-Item MinesweeperAI.exe).LastWriteTime)"
        } else {
          Write-Error "   ✗ EXE文件不存在"
          exit 1
        }
        Write-Host ""

        # 检查EXE基本信息
        Write-Host "6. 检查EXE信息..."
        Write-Host "   文件名: MinesweeperAI.exe"
        Write-Host "   位置: $((Get-Location).Path)"
        Write-Host ""

    - name: Upload test results
      if: always()
      run: |
        Write-Host "========================================"
        Write-Host "测试总结"
        Write-Host "========================================"
        Write-Host ""
        Write-Host "✅ EXE文件: 已成功创建"
        Write-Host "✅ 下载测试: 通过"
        Write-Host "✅ 文件验证: 通过"
        Write-Host ""
        Write-Host "下一步:"
        Write-Host "1. 下载 Artifacts 中的 MinesweeperAI-Windows.zip"
        Write-Host "2. 在Windows上运行 MinesweeperAI.exe"
        Write-Host "3. 打开扫雷游戏，观察AI自动玩游戏"
        Write-Host ""
        Write-Host "构建页面: https://github.com/$env:GITHUB_REPOSITORY/actions"
        Write-Host "========================================"

    - name: Upload EXE as artifact (for easy access)
      uses: actions/upload-artifact@v4
      with:
        name: MinesweeperAI-Verified
        path: MinesweeperAI.exe
        retention-days: 30
