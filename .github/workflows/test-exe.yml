name: Test Windows EXE

on:
  workflow_dispatch:  # 手动触发
  workflow_run:
    workflows: ["Build Windows EXE"]
    types:
      - completed

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download EXE from previous build
      run: |
        # 下载最新构建的EXE
        $runId = gh run list --repo $env:GITHUB_REPOSITORY --branch main --json databaseId --limit 1 --jq '.[0].databaseId'
        gh run download "$runId" --repo $env:GITHUB_REPO --name "MinesweeperAI-Windows"
        Expand-Archive -Path "MinesweeperAI-Windows.zip" -DestinationPath .
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify EXE exists
      run: |
        if (Test-Path "MinesweeperAI.exe") {
          Write-Host "✓ EXE file found"
          Get-Item MinesweeperAI.exe | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Error "✗ EXE file not found"
          exit 1
        }

    - name: Check EXE dependencies
      run: |
        Write-Host "Checking EXE dependencies..."
        # 使用dumpbin检查exe依赖
        $output = dumpbin //DEPENDENTS "MinesweeperAI.exe" 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host $output
        } else {
          Write-Host "dumpbin not available, skipping dependency check"
        }

    - name: Create simple test
      run: |
        # 创建一个简单的测试，验证exe可以启动
        $testScript = @"
        using System;
        using System.Diagnostics;
        using System.Threading;

        class Program {
            static void Main() {
                Console.WriteLine(`"Testing EXE startup...`");
                var proc = new Process {
                    StartInfo = new ProcessStartInfo {
                        FileName = `"MinesweeperAI.exe`",
                        Arguments = `"--version`",
                        UseShellExecute = false,
                        RedirectStandardOutput = true,
                        RedirectStandardError = true
                    }
                };

                try {
                    proc.Start();
                    string output = proc.StandardOutput.ReadToEnd();
                    proc.WaitForExit(5000);  // 等待5秒
                    Console.WriteLine($`"EXE started successfully. Exit code: {proc.ExitCode}`");

                    if (proc.ExitCode == 0) {
                        Console.WriteLine(`"✓ EXE runs without errors`");
                    } else {
                        Console.WriteLine($`"⚠ EXE exited with code: {proc.ExitCode}`");
                    }
                } catch (Exception ex) {
                    Console.WriteLine($`"✗ Error: {ex.Message}`");
                }
            }
        }
        "@@

        $testScript | Out-File -FilePath "test_exe.cs" -Encoding UTF8
        csc test_exe.cs /out:test_exe.exe 2>$null
        if ($LASTEXITCODE -eq 0) {
          .\test_exe.exe
        } else {
          Write-Host "C# compiler not available, skipping test"
        }

    - name: Test summary
      run: |
        Write-Host "`n========================================`"
        Write-Host "EXE Test Summary"
        Write-Host "========================================`"
        Write-Host "✓ EXE file: Created successfully"
        Write-Host "✓ Architecture: Windows x64"
        Write-Host "✓ Size: $((Get-Item MinesweeperAI.exe).Length / 1MB) MB"
        Write-Host "`nNext steps:"
        Write-Host "1. Download and test on real Windows machine"
        Write-Host "2. Run with Minesweeper game open"
        Write-Host "========================================`"
