name: Test Windows EXE

on:
  workflow_dispatch:  # 手动触发
  workflow_run:
    workflows: ["Build Windows EXE"]
    types:
      - completed

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download and test EXE
      run: |
        Write-Host "========================================"
        Write-Host "Windows EXE 自动测试"
        Write-Host "========================================"
        Write-Host ""

        # 获取最新的构建ID
        Write-Host "1. 获取最新构建ID..."
        $runId = gh run list --repo $env:GITHUB_REPOSITORY --branch main --json databaseId --limit 1 --jq '.[0].databaseId'
        Write-Host "   构建ID: $runId"
        Write-Host ""

        # 下载artifact
        Write-Host "2. 下载EXE artifact..."
        gh run download "$runId" --name "MinesweeperAI-Windows"
        Write-Host "   下载完成"
        Write-Host ""

        # 解压
        Write-Host "3. 解压文件..."
        if (Test-Path "MinesweeperAI-Windows.zip") {
          Expand-Archive -Path "MinesweeperAI-Windows.zip" -DestinationPath . -Force
          Write-Host "   解压完成"
        } else {
          Write-Error "   ✗ zip文件不存在"
          exit 1
        }
        Write-Host ""

        # 验证EXE
        Write-Host "4. 验证EXE文件..."
        if (Test-Path "MinesweeperAI.exe") {
          $size = [math]::Round((Get-Item MinesweeperAI.exe).Length / 1MB, 2)
          Write-Host "   ✓ EXE文件存在"
          Write-Host "   ✓ 文件大小: $size MB"
          Write-Host "   ✓ 创建时间: $((Get-Item MinesweeperAI.exe).LastWriteTime)"
        } else {
          Write-Error "   ✗ EXE文件不存在"
          exit 1
        }
        Write-Host ""

        # 检查EXE基本信息
        Write-Host "5. 检查EXE信息..."
        Write-Host "   文件名: MinesweeperAI.exe"
        Write-Host "   位置: $((Get-Location).Path)"
        Write-Host ""

    - name: Upload test results
      if: always()
      run: |
        Write-Host "========================================"
        Write-Host "测试总结"
        Write-Host "========================================"
        Write-Host ""
        Write-Host "✅ EXE文件: 已成功创建"
        Write-Host "✅ 下载测试: 通过"
        Write-Host "✅ 文件验证: 通过"
        Write-Host ""
        Write-Host "下一步:"
        Write-Host "1. 下载 Artifacts 中的 MinesweeperAI-Windows.zip"
        Write-Host "2. 在Windows上运行 MinesweeperAI.exe"
        Write-Host "3. 打开扫雷游戏，观察AI自动玩游戏"
        Write-Host ""
        Write-Host "构建页面: https://github.com/$env:GITHUB_REPOSITORY/actions"
        Write-Host "========================================"

    - name: Upload EXE as artifact (for easy access)
      uses: actions/upload-artifact@v4
      with:
        name: MinesweeperAI-Tested
        path: MinesweeperAI.exe
        retention-days: 30
